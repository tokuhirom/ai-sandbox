#!/bin/bash
set -euo pipefail

usage() {
  echo "Usage: ai-sandbox <branch> [claude|codex|bash]" >&2
  exit 1
}

BRANCH="${1:?$(usage)}"
TOOL="${2:-bash}"

# .git のあるディレクトリを探す
find_repo_root() {
  local dir="$PWD"
  while [[ "$dir" != "/" ]]; do
    if [[ -d "$dir/.git" ]]; then
      echo "$dir"
      return
    fi
    dir="$(dirname "$dir")"
  done
  echo "Error: not in a git repository" >&2
  exit 1
}

REPO_ROOT="$(find_repo_root)"
WORKTREE_DIR="${REPO_ROOT}/.git/worktrees-sandbox/${BRANCH}"

# worktree がなければ作成
if [[ ! -d "$WORKTREE_DIR" ]]; then
  echo "Creating worktree for branch '${BRANCH}'..."
  git -C "$REPO_ROOT" worktree add "$WORKTREE_DIR" "$BRANCH" 2>/dev/null \
    || git -C "$REPO_ROOT" worktree add -b "$BRANCH" "$WORKTREE_DIR"
fi

case "$TOOL" in
  claude) CMD="claude --dangerously-skip-permissions" ;;
  codex)  CMD="codex --dangerously-bypass-approvals-and-sandbox" ;;
  bash)   CMD="bash" ;;
  *)      echo "Unknown tool: $TOOL" >&2; usage ;;
esac

BWRAP_ARGS=(
  # システム領域を読み取り専用でマウント (/home を除く)
  --ro-bind /usr /usr
  --ro-bind /bin /bin
  --ro-bind /sbin /sbin
  --ro-bind /lib /lib
  --ro-bind /lib64 /lib64
  --ro-bind /etc /etc
  --ro-bind /run /run
  --dev /dev
  --proc /proc
  --tmpfs /tmp
  --tmpfs /home
)

# 存在する場合のみマウントするシステムディレクトリ
for dir in /opt /snap /nix /lib32; do
  [[ -d "$dir" ]] && BWRAP_ARGS+=(--ro-bind "$dir" "$dir")
done

BWRAP_ARGS+=(
  # HOME 配下: 必要なディレクトリのみ公開
  --ro-bind "${HOME}/.local/share/mise" "${HOME}/.local/share/mise"
  --ro-bind "${HOME}/.local/share/claude" "${HOME}/.local/share/claude"
  --ro-bind "${HOME}/.local/bin" "${HOME}/.local/bin"
  --ro-bind "${HOME}/.rustup" "${HOME}/.rustup"
  --bind "${HOME}/.cargo" "${HOME}/.cargo"
  --ro-bind "${HOME}/.gitconfig" "${HOME}/.gitconfig"
  --ro-bind "${HOME}/.config/gh" "${HOME}/.config/gh"
  --bind "${HOME}/.claude" "${HOME}/.claude"
  --bind "${HOME}/.claude.json" "${HOME}/.claude.json"
  --bind "${HOME}/.codex" "${HOME}/.codex"
  --bind "${HOME}/.ssh" "${HOME}/.ssh"

  # worktree と .git だけ書き込み可能
  --bind "${WORKTREE_DIR}" "${WORKTREE_DIR}"
  --bind "${REPO_ROOT}/.git" "${REPO_ROOT}/.git"

  --share-net
  --unshare-pid
  --die-with-parent
  --chdir "${WORKTREE_DIR}"
  --setenv HOME "${HOME}"
  --setenv ANTHROPIC_API_KEY "${ANTHROPIC_API_KEY:-}"
  --setenv OPENAI_API_KEY "${OPENAI_API_KEY:-}"
)

# D-Bus ソケット (gh の keyring 認証に必要)
if [[ -S "${XDG_RUNTIME_DIR:-}/bus" ]]; then
  BWRAP_ARGS+=(--bind "${XDG_RUNTIME_DIR}/bus" "${XDG_RUNTIME_DIR}/bus")
fi

# SSH agent ソケット
if [[ -n "${SSH_AUTH_SOCK:-}" && -S "$SSH_AUTH_SOCK" ]]; then
  BWRAP_ARGS+=(--bind "$SSH_AUTH_SOCK" "$SSH_AUTH_SOCK")
fi

exec bwrap "${BWRAP_ARGS[@]}" bash -c "$CMD"
